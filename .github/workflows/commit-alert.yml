# -------------------------------------------------------
# GitHub Actions Workflow: Commit Alert
# Sends an email notification whenever a new commit
# is pushed to the specified branch, with a summary of changes.
# -------------------------------------------------------

name: Commit Alert

on:
  push:
    branches:
      - main  # You can add others like "dev", "staging" if needed

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repo so we can read commit details
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch at least 2 commits to compare

      # Step 2: Gather commit info (repo, branch, summary, etc.)
      - name: Collect commit details
        id: commit_info
        run: |
          echo "REPO_NAME=${GITHUB_REPOSITORY}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B)" >> $GITHUB_ENV
          echo "AUTHOR_NAME=$(git log -1 --pretty=%an)" >> $GITHUB_ENV
          echo "COMMIT_URL=${{ github.event.head_commit.url }}" >> $GITHUB_ENV

          # Generate short summary like "3 files changed, 25 insertions(+), 8 deletions(-)"
          SUMMARY=$(git diff --shortstat HEAD~1 HEAD)
          echo "SUMMARY=$SUMMARY" >> $GITHUB_ENV

          # List top 5 changed files
          echo "FILE_DETAILS<<EOF" >> $GITHUB_ENV
          git diff --numstat HEAD~1 HEAD | awk '
            NR <= 5 {
              added=$1; removed=$2; file=$3;
              printf "ðŸ“„ %s â€” +%s / -%s\n", file, added, removed;
            }
          ' >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Step 3: Send email notification
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP server configuration
          server_address: mail.genetech.co
          server_port: 587

          # Authentication credentials (stored as repository secrets)
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}

          # Email content
          subject: "New Commit in ${{ env.REPO_NAME }} [${{ env.BRANCH_NAME }}]"
          body: |
            ðŸš¨ **New Commit Alert**

            **Repository:** ${{ env.REPO_NAME }}
            **Branch:** ${{ env.BRANCH_NAME }}
            **Author:** ${{ env.AUTHOR_NAME }}
            **Commit Message:** ${{ env.COMMIT_MESSAGE }}
            **Commit URL:** ${{ env.COMMIT_URL }}

            **Summary of Changes:**
            ```
            ${{ env.SUMMARY }}
            ```

            **Top Changed Files (up to 5):**
            ```
            ${{ env.FILE_DETAILS }}
            ```

          # Recipient and sender details
          to: maalik.hemani@genetech.co
          from: alarm@genetech.co
