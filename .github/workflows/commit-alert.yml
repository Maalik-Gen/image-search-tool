# -------------------------------------------------------
# GitHub Actions Workflow: Commit Alert
# Sends an email notification whenever a new commit
# is pushed to the specified branch, including details
# like repo name, branch, author, and changed lines.
# -------------------------------------------------------

name: Commit Alert

on:
  push:
    branches:
      - main  # You can add others like "dev", "staging" if needed

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out the repo so we can read commit details
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch at least 2 commits to compare

      # Step 2: Gather commit info (repo, branch, changes, etc.)
      - name: Collect commit details
        id: commit_info
        run: |
          echo "REPO_NAME=${GITHUB_REPOSITORY}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B)" >> $GITHUB_ENV
          echo "AUTHOR_NAME=$(git log -1 --pretty=%an)" >> $GITHUB_ENV
          echo "COMMIT_URL=${{ github.event.head_commit.url }}" >> $GITHUB_ENV

          # Get list of changed files
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          git diff --name-only HEAD~1 HEAD >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Get first 10 changed lines with file names
          echo "CHANGED_LINES<<EOF" >> $GITHUB_ENV
          git diff HEAD~1 HEAD | awk '
            /^\+\+\+ b\// {
              file = substr($0, 7);
            }
            /^[\+\-]/ && !/^[\+\-]{3}/ {
              if (count < 10) {
                print file ": " $0;
                count++;
              }
            }
          ' >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Get change locations (file names with line numbers)
          echo "CHANGE_LOCATIONS<<EOF" >> $GITHUB_ENV
          git diff -U0 HEAD~1 HEAD | awk '
            /^\+\+\+ b\// {
              file = substr($0, 7);
            }
            /^@@/ {
              match($0, /\+([0-9]+)(,([0-9]+))?/, arr);
              line_start = arr[1];
              line_count = arr[3] ? arr[3] : 1;
              if (line_count == 1) {
                print file " â€” line " line_start;
              } else {
                print file " â€” lines " line_start "-" (line_start + line_count - 1);
              }
              count++;
              if (count >= 20) exit;
            }
          ' >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Step 3: Send email notification
      - name: Send email notification
        uses: dawidd6/action-send-mail@v3
        with:
          # SMTP server configuration
          server_address: mail.genetech.co
          server_port: 587

          # Authentication credentials (stored as repository secrets)
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}

          # Email content
          subject: "New Commit in ${{ env.REPO_NAME }} [${{ env.BRANCH_NAME }}]"
          body: |
            ðŸš¨ **New Commit Alert**

            **Repository:** ${{ env.REPO_NAME }}
            **Branch:** ${{ env.BRANCH_NAME }}
            **Author:** ${{ env.AUTHOR_NAME }}
            **Commit Message:** ${{ env.COMMIT_MESSAGE }}
            **Commit URL:** ${{ env.COMMIT_URL }}

            **Changed Files:**
            ```
            ${{ env.CHANGED_FILES }}
            ```

            **Change Locations (first 20 lines):**
            ```
            ${{ env.CHANGE_LOCATIONS }}
            ```

            **First 10 Changed Lines (additions/removals):**
            ```
            ${{ env.CHANGED_LINES }}
            ```

          # Recipient and sender details
          to: maalik.hemani@genetech.co
          from: alarm@genetech.co